generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["event"]
}

model Event {
  id              Int           @id @default(autoincrement())
  uuid            String        @unique @db.Char(36)
  name            String        @db.VarChar(255)
  start_date      DateTime      @db.Timestamp(6)
  end_date        DateTime?     @db.Timestamp(6)
  available_seats Int
  description     String?
  ticket_type_id  String?       @db.VarChar(255)
  category_id     Int?
  event_type      String?       @db.VarChar(255)
  created_at      DateTime?     @default(now()) @db.Timestamp(6)
  updated_at      DateTime?     @default(now()) @updatedAt @db.Timestamp(6)
  status          String        @default("atv") @db.VarChar(3)
  category        Category?     @relation(fields: [category_id], references: [id], onDelete: Restrict, onUpdate: NoAction)
  tickets         Ticket[]
  transactions    Transaction[]
  vouchers        Voucher[]

  @@map("events")
  @@schema("event")
}

model Ticket {
  id                  Int                 @id @default(autoincrement())
  uuid                String              @unique @db.Char(36)
  event_id            Int
  price               Decimal             @db.Decimal(10, 2)
  created_at          DateTime?           @default(now()) @db.Timestamp(6)
  updated_at          DateTime?           @default(now()) @updatedAt @db.Timestamp(6)
  status              String              @default("atv") @db.VarChar(3)
  ticket_transactions TicketTransaction[]
  event               Event               @relation(fields: [event_id], references: [id], onUpdate: NoAction)

  @@map("tickets")
  @@schema("event")
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(255)
  description String?
  status      String    @default("atv") @db.VarChar(3)
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  updated_at  DateTime? @default(now()) @updatedAt @db.Timestamp(6)
  events      Event[]

  @@map("categories")
  @@schema("event")
}

model Voucher {
  id              Int       @id @default(autoincrement())
  uuid            String    @unique @db.Char(36)
  event_id        Int
  start_date      DateTime  @db.Timestamp(6)
  end_date        DateTime  @db.Timestamp(6)
  status          String    @default("atv") @db.VarChar(3)
  created_at      DateTime? @default(now()) @db.Timestamp(6)
  updated_at      DateTime? @default(now()) @updatedAt @db.Timestamp(6)
  code            String    @db.VarChar(50)
  discount_type   String    @db.VarChar(20)
  discount_amount Decimal   @db.Decimal(10, 2)
  max_uses        Int?
  used_count      Int?      @default(0)
  event           Event     @relation(fields: [event_id], references: [id], onUpdate: NoAction)

  @@map("vouchers")
  @@schema("event")
}

model Transaction {
  id                  Int                 @id @default(autoincrement())
  uuid                String              @unique @db.Char(36)
  event_id            Int
  status              Int
  created_at          DateTime            @default(now()) @db.Timestamp(6)
  created_by          Int?
  confirmed_at        DateTime?           @db.Timestamp(6)
  confirmed_by        Int?
  ticket_transactions TicketTransaction[]
  confirmer           User?               @relation("TransactionConfirmer", fields: [confirmed_by], references: [id], onUpdate: NoAction, map: "fk_transactions_confirmed_by")
  creator             User?               @relation("TransactionCreator", fields: [created_by], references: [id], onUpdate: NoAction, map: "fk_transactions_created_by")
  event               Event               @relation(fields: [event_id], references: [id], onUpdate: NoAction)

  @@map("transactions")
  @@schema("event")
}

model TicketTransaction {
  transaction_id Int
  ticket_id      Int
  quantity       Int         @default(1)
  ticket         Ticket      @relation(fields: [ticket_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  transaction    Transaction @relation(fields: [transaction_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([transaction_id, ticket_id])
  @@map("ticket_transactions")
  @@schema("event")
}

model Point {
  id           Int       @id @default(autoincrement())
  user_id      Int
  points_count Int
  expiry       DateTime? @db.Timestamp(6)
  created_at   DateTime  @default(now()) @db.Timestamp(6)
  updated_at   DateTime  @default(now()) @updatedAt @db.Timestamp(6)
  user         User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_points_user_id")

  @@index([expiry], map: "idx_points_expiry")
  @@index([user_id, expiry], map: "idx_points_user_expiry")
  @@index([user_id], map: "idx_points_user_id")
  @@map("points")
  @@schema("event")
}

model User {
  id                     Int           @id @default(autoincrement())
  username               String        @unique(map: "idx_users_username") @db.VarChar(255)
  profile_picture        String?
  created_at             DateTime      @default(now()) @db.Timestamp(6)
  updated_at             DateTime      @default(now()) @updatedAt @db.Timestamp(6)
  referral_code          String        @unique(map: "users_referral_code_unique") @default(dbgenerated("(gen_random_uuid())::text")) @db.VarChar(36)
  role                   Int           @default(1)
  coupons                Coupon[]
  points                 Point[]
  confirmed_transactions Transaction[] @relation("TransactionConfirmer")
  created_transactions   Transaction[] @relation("TransactionCreator")

  @@map("users")
  @@schema("event")
}

model Coupon {
  id              Int      @id @default(autoincrement())
  user_id         Int
  discount_amount Int
  created_at      DateTime @default(now()) @db.Timestamp(6)
  user            User     @relation(fields: [user_id], references: [id], onUpdate: NoAction, map: "fk_coupons_user_id")
  expiry          DateTime? @db.Timestamp(6)

  @@index([user_id], map: "idx_coupons_user_id")
  @@index([created_at], map: "idx_coupons_created_at")
  @@map("coupons")
  @@schema("event")
}
